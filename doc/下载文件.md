# 下载文件(Object)

OSS Go SDK提供了丰富的文件下载接口，用户可以通过以下方式从OSS中下载文件(Object)：

- 下载到数据流io.ReadCloser
- 下载到本地文件
- 分段下载

## 简单下载

> 提示：
> 
> - 简单下载的示例代码在`sample/get_object.go`。
> 

### 下载文件到数据流io.ReadCloser
```go
    import (
        "fmt"
        "io/ioutil"
        "github.com/aliyun/aliyun-oss-go-sdk/oss"
    )
    
    client, err := oss.New("Endpoint", "AccessKeyId", "AccessKeySecret")
    if err != nil {
        // HandleError(err)
    }

    bucket, err := client.Bucket("my-bucket")
    if err != nil {
        // HandleError(err)
    }
    
	body, err := bucket.GetObject("my-object")
	if err != nil {
		// HandleError(err)
	}
	data, err := ioutil.ReadAll(body)
	if err != nil {
		// HandleError(err)
	}
	body.Close()
	fmt.Println("data:", string(data))
```

> 注意：
> 
> - io.ReadCloser数据读取完毕后，需要调用Close关闭。
> 

### 下载文件到缓存中
```go
    import (
        "bytes"
        "io"
        "github.com/aliyun/aliyun-oss-go-sdk/oss"
    )
    
	client, err := oss.New("Endpoint", "AccessKeyId", "AccessKeySecret")
    if err != nil {
        // HandleError(err)
    }

    bucket, err := client.Bucket("my-bucket")
    if err != nil {
        // HandleError(err)
    }
    
    body, err := bucket.GetObject("my-object")
    if err != nil {
        // HandleError(err)
    }
	buf := new(bytes.Buffer)
	io.Copy(buf, body)
	body.Close()
```

### 下载文件到本地文件流中
```go
    import (
            "io"
            "os"
            "github.com/aliyun/aliyun-oss-go-sdk/oss"
    )

	client, err := oss.New("Endpoint", "AccessKeyId", "AccessKeySecret")
    if err != nil {
        // HandleError(err)
    }

    bucket, err := client.Bucket("my-bucket")
    if err != nil {
        // HandleError(err)
    }
    
    body, err := bucket.GetObject("my-object")
    if err != nil {
        // HandleError(err)
    }
    defer body.Close()
	
	fd, err := os.OpenFile("LocalFile", os.O_WRONLY|os.O_CREATE, 0660)
    if err != nil {
        // HandleError(err)  
    }
    defer fd.Close()
	
	io.Copy(fd, body)
```

### 下载文件(Object)到本地文件
```go
    import "github.com/aliyun/aliyun-oss-go-sdk/oss"
    
    client, err := oss.New("Endpoint", "AccessKeyId", "AccessKeySecret")
    if err != nil {
        // HandleError(err)
    }

    bucket, err := client.Bucket("my-bucket")
    if err != nil {
        // HandleError(err)
    }
    
    err = bucket.GetObjectToFile("my-object", "LocalFile")
    if err != nil {
        // HandleError(err)
    }
```

### 下载文件时指定限定条件

下载文件时，用户可以指定一个或多个限定条件，所有的限定条件都满足时下载，不满足时报错不下载文件。
可以使用的限定条件如下：

|参数|说明|
|:---|:---|
|IfModifiedSince|如果指定的时间早于实际修改时间，则正常传送。否则返回错误。|
|IfUnmodifiedSince|如果传入参数中的时间等于或者晚于文件实际修改时间，则正常传输文件；否则返回错误。|
|IfMatch|如果传入期望的ETag和object的 ETag匹配，则正常传输；否则返回错误。|
|IfNoneMatch|如果传入的ETag值和Object的ETag不匹配，则正常传输；否则返回错误。|

```go
    import "time"
    import "github.com/aliyun/aliyun-oss-go-sdk/oss"
    
    client, err := oss.New("Endpoint", "AccessKeyId", "AccessKeySecret")
    if err != nil {
        // HandleError(err)
    }
    
    bucket, err := client.Bucket("my-bucket")
    if err != nil {
        // HandleError(err)
    }
    
    date := time.Date(2015, time.November, 10, 23, 0, 0, 0, time.UTC)
    
    // 限定条件不满足，不下载文件
    err = bucket.GetObjectToFile("my-object", "LocalFile", oss.IfModifiedSince(date))
    if err == nil {
        // HandleError(err)
    }
    
    // 满足限定条件，下载文件
    err = bucket.GetObjectToFile("my-object", "LocalFile", oss.IfUnmodifiedSince(date))
    if err != nil {
        // HandleError(err)
    }
```

> 提示：
> 
> - ETag的值可以通过Bucket.GetObjectDetailedMeta获取。
> - Bucket.GetObject，Bucket.GetObjectToFile都支持限定条件。
>

### 文件压缩下载
文件可以压缩下载，目前支持GZIP压缩。
```go
    import "github.com/aliyun/aliyun-oss-go-sdk/oss"
    
    client, err := oss.New("Endpoint", "AccessKeyId", "AccessKeySecret")
    if err != nil {
        // HandleError(err)
    }
    
    bucket, err := client.Bucket("my-bucket")
    if err != nil {
        // HandleError(err)
    }
    
    err = bucket.GetObjectToFile("my-object.txt", "LocalFile.gzip", oss.AcceptEncoding("gzip"))
    if err != nil {
        // HandleError(err)
    }
```

## 分段下载
当下载大文件时，如果网络不稳定或者程序崩溃了，则整个下载就失败了。用户
不得不重头再来，这样做不仅浪费资源，在网络不稳定的情况下，往往重试多次
还是无法完成下载。分段下载就是把文件分成多个小段，逐个下载。

### 封装分段下载
可以调用Bucket.DownloadFile完成分段下载。分段下载是将大文件分成段，分别下载每段。它有以下参数：

- "my-object" 要下载的Object名字。
- filePath 下载到本地文件的路径。
- partSize 分段大小，单位是Bytes，最小值1B，最大5GB。

```go
    import "github.com/aliyun/aliyun-oss-go-sdk/oss"
    
    client, err := oss.New("Endpoint", "AccessKeyId", "AccessKeySecret")
    if err != nil {
        // HandleError(err)
    }
    
    bucket, err := client.Bucket("my-bucket")
    if err != nil {
        // HandleError(err)
    }
    
    // 分段大小是1MB
    err = bucket.DownloadFile("my-object", "LocalFile", 1024 * 1024)
    if err != nil {
        // HandleError(err)
    }
```

> 提示：
> 
> - Bucket.DownloadFile支持IfModifiedSince、IfUnmodifiedSince、IfMatch、IfNoneMatch限定条件。
>

### GetObject实现分段下载
Bucket.GetObject/Bucket.GetObjectToFile，支持选项Range指定下载文件(Object)的范围。如设定Range为 bytes=0-9，表示传送第0到第9这10个字符,如果不符合范围规范，则传送全部内容。通过Range参数可以支持分段下载。

> 提示：
> 
> - 分段下载的示例代码在`sample/get_object.go`。

```go
    import (
        "io"
        "os"
        "strconv"
        "github.com/aliyun/aliyun-oss-go-sdk/oss"
    )
    
    client, err := oss.New("Endpoint", "AccessKeyId", "AccessKeySecret")
    if err != nil {
        // HandleError(err)
    }
    
    bucket, err := client.Bucket("my-bucket")
    if err != nil {
        // HandleError(err)
    }
    
    // 获取文件(Object)长度
    meta, err := bucket.GetObjectDetailedMeta("my-object")
    if err != nil {
        // HandleError(err)  
    }
    
    // 分段大小是1MB
    var partSize int64 = 1024 * 1024
    objectSize, err := strconv.ParseInt(meta.Get(oss.HTTPHeaderContentLength), 10, 0)
    
    fd, err := os.OpenFile("LocalFile", os.O_WRONLY|os.O_CREATE, 0660)
    if err != nil {
        // HandleError(err)  
    }
    defer fd.Close()
    
    // 分段下载
    for i := int64(0); i < objectSize; i += partSize {
        option := oss.Range(i, oss.GetPartEnd(i, objectSize, partSize))
		body, err := bucket.GetObject("my-object", option)
		if err != nil {
			// HandleError(err)
		}
		io.Copy(fd, body)
		body.Close()
    }
```

> 提示：
> 
> - 通过Range参数，您可以并发下载大文件。
> - 分段大小，单位是Bytes，最小值1B，最大5GB。
> - 使用GetObject下载，LocalFile需要用户创建并打开。
> - GetObjectToFile每次写文件都是追加写，支持分段下载。
